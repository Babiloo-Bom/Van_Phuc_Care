# ============================================
# Van Phuc Care - Development Environment
# Hot Reload + Volume Mounts
# ============================================

services:
  # ============================================
  # Backend API Server (Development)
  # ============================================
  api:
    build:
      context: ./server-vpc
      dockerfile: Dockerfile.dev
    container_name: vpc-api-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/vanphuccare?authSource=admin
      - JWT_SECRET=${JWT_SECRET:-dev_jwt_secret}
      - JWT_EXPIRE=7d
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET_NAME=van-phuc-care
      # Mail
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Van Phuc Care}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      # VNpay
      - VNP_TMNCODE=VPCTEST1
      - VNP_HASHSECRET=95M6E1P08UICHY6HS515HCXC9ORKNZRF
      - VNP_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
      - VNP_RETURN_URL=http://localhost:3102/vnpay-return
      - IPN_URL=http://localhost:3000/orders/payment/vnpay-ipn
      # Cloudflare config
      - CLOUDFLARE_R2_BUCKET_NAME=vanphuccare-video-edu
      - CLOUDFLARE_R2_PUBLIC_URL=https://pub-d52b327cd86048b0aff51ec33d95f7fe.r2.dev
      - CLOUDFLARE_R2_ACCOUNT_ID=ccf4b0496c6ff822f2b165e18a830d99
      - CLOUDFLARE_R2_ACCESS_KEY_ID=42f261e5d63b284d51b8f5b3ffa9d894
      - CLOUDFLARE_R2_SECRET_ACCESS_KEY=8fba295a9781fe61e7c0568004c2ec1487184396bb19fd9e30f6d0dd641d8682
      # Base url elearning for email
      - BASE_URL_ELEARNING=http://localhost:3102
    volumes:
      - ./server-vpc/src:/app/src:cached
      - ./server-vpc/dist:/app/dist:cached
      - ./server-vpc/package.json:/app/package.json:ro
      - /app/node_modules
    networks:
      - vpc-network
    depends_on:
      - mongodb
      - minio
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # MinIO Object Storage
  # ============================================
  minio:
    image: minio/minio:latest
    container_name: vpc-minio-dev
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data-dev:/data
    command: server /data --console-address ":9001"
    networks:
      - vpc-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # MongoDB Database
  # ============================================
  mongodb:
    image: mongo:7-jammy
    container_name: vpc-mongodb-dev
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-password}
      - MONGO_INITDB_DATABASE=vanphuccare
    volumes:
      - mongodb-data-dev:/data/db
      - mongodb-config-dev:/data/configdb
    networks:
      - vpc-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Admin Portal (Development)
  # ============================================
  admin:
    build:
      context: ./admin-vpc-v3
      dockerfile: Dockerfile.dev
    container_name: vpc-admin-dev
    restart: unless-stopped
    ports:
      - "3100:3000"
    environment:
      - NODE_ENV=development
      - NUXT_PUBLIC_API_HOST=http://api:3000
      - NUXT_PUBLIC_API_BASE=http://api:3000/a
      - NUXT_PUBLIC_TINYMCE_KEY=${TINYMCE_KEY}
      - NUXT_PUBLIC_APP_NAME=Admin Portal - Van Phuc Care
      - NUXT_PUBLIC_APP_URL=http://localhost:3100
    volumes:
      - ./admin-vpc-v3:/app:cached
      - /app/node_modules
      - /app/.nuxt
      - /app/.output
    networks:
      - vpc-network
    depends_on:
      - api
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # CRM Portal (Development)
  # ============================================
  crm:
    build:
      context: ./crm-vpc-v3
      dockerfile: Dockerfile.dev
    container_name: vpc-crm-dev
    restart: unless-stopped
    ports:
      - "3101:3000"
    environment:
      - NODE_ENV=development
      # Empty apiHost so browser uses relative paths, proxied by Nuxt server
      - NUXT_PUBLIC_API_HOST=
      - NUXT_PUBLIC_API_BASE=/api/u
      - NUXT_PUBLIC_API_BASE_URL=
      # Internal API host for server-side proxy (Docker network)
      - NUXT_API_HOST_INTERNAL=http://api:3000
      - NUXT_PUBLIC_TINYMCE_KEY=${TINYMCE_KEY}
      - NUXT_PUBLIC_APP_NAME=CRM Portal - Van Phuc Care
      - NUXT_PUBLIC_APP_URL=http://localhost:3101
    volumes:
      - ./crm-vpc-v3:/app:cached
      - /app/node_modules
      - /app/.nuxt
      - /app/.output
    networks:
      - vpc-network
    depends_on:
      - api
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # E-Learning Portal (Development)
  # ============================================
  elearning:
    build:
      context: ./elerning-vpc-v3
      dockerfile: Dockerfile.dev
    container_name: vpc-elearning-dev
    restart: unless-stopped
    ports:
      - "3102:3002"
    environment: 
      - NODE_ENV=development
      - NUXT_PUBLIC_API_HOST=http://api:3000
      - NUXT_PUBLIC_API_BASE=http://api:3000/u
      - NUXT_PUBLIC_TINYMCE_KEY=${TINYMCE_KEY}
      - NUXT_PUBLIC_APP_NAME=E-Learning Portal - Van Phuc Care
      - NUXT_PUBLIC_APP_URL=http://localhost:3102
    volumes:
      - ./elerning-vpc-v3:/app:cached
      - /app/node_modules
      - /app/.nuxt
      - /app/.output
    networks:
      - vpc-network
    depends_on:
      - api
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================
# Networks
# ============================================
networks:
  vpc-network:
    driver: bridge
    name: van-phuc-care-dev-network

# ============================================
# Volumes (Development - Separate from prod)
# ============================================
volumes:
  mongodb-data-dev:
    name: vpc-mongodb-data-dev
  mongodb-config-dev:
    name: vpc-mongodb-config-dev
  minio-data-dev:
    name: vpc-minio-data-dev
